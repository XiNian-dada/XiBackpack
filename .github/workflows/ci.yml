name: CI/CD - Auto Release from POM Version

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取所有历史记录，用于生成完整的commit信息

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'adopt'
        cache: maven

    - name: Build with Maven
      run: mvn -B compile

    - name: Run Tests
      run: mvn -B test

    - name: Package
      run: mvn -B package -DskipTests

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: XiBackpack-Build
        path: target/*.jar
        retention-days: 7

  auto-release:
    name: Auto Release from POM
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'adopt'
        cache: maven

    - name: 获取 POM 版本号
      id: get_version
      run: |
        VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT

    - name: 检查 Tag 是否已存在
      id: check_tag
      run: |
        if git rev-parse "${{ steps.get_version.outputs.tag_name }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: 创建 Tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a "${{ steps.get_version.outputs.tag_name }}" -m "Release ${{ steps.get_version.outputs.tag_name }}"
        git push origin "${{ steps.get_version.outputs.tag_name }}"

    - name: 等待 Tag 同步到 GitHub API
      if: steps.check_tag.outputs.exists == 'false'
      run: sleep 5

    - name: 下载构建产物
      if: steps.check_tag.outputs.exists == 'false'
      uses: actions/download-artifact@v4
      with:
        name: XiBackpack-Build
        path: target

    - name: 生成 Release Notes
      id: generate_release_notes
      if: steps.check_tag.outputs.exists == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          // 获取当前版本和tag
          const version = '${{ steps.get_version.outputs.version }}';
          const tagName = '${{ steps.get_version.outputs.tag_name }}';
          
          // 获取所有tags并排序
          const tags = await github.rest.git.listMatchingRefs({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'refs/tags/',
            per_page: 100
          });
          
          // 解析tag并按版本号排序（仅包含v开头的语义化版本）
          const tagNames = tags.data.map(tag => tag.ref.replace('refs/tags/', ''))
            .filter(tag => /^v\d+\.\d+\.\d+$/.test(tag))
            .sort((a, b) => {
              const parseVersion = (v) => v.slice(1).split('.').map(Number);
              const aVer = parseVersion(a);
              const bVer = parseVersion(b);
              for (let i = 0; i < 3; i++) {
                if (aVer[i] !== bVer[i]) {
                  return bVer[i] - aVer[i];
                }
              }
              return 0;
            });
          
          // 找到当前tag的位置
          const currentIndex = tagNames.indexOf(tagName);
          let previousTag = null;
          if (currentIndex < tagNames.length - 1) {
            previousTag = tagNames[currentIndex + 1];
          }
          
          // 获取commits
          let commits = [];
          if (previousTag) {
            // 获取两个tag之间的commits
            const compareResponse = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: previousTag,
              head: tagName
            });
            commits = compareResponse.data.commits;
          } else {
            // 如果是第一个tag，获取所有commits
            const commitResponse = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            commits = commitResponse.data;
          }
          
          // 生成Release Notes
          let releaseNotes = `# XiBackpack ${version}\n\n`;
          releaseNotes += `## 变更内容\n\n`;
          
          if (commits.length === 0) {
            releaseNotes += `- 自上次发布以来没有变更\n`;
          } else {
            commits.forEach(commit => {
              const commitMessage = commit.commit.message.split('\n')[0];
              releaseNotes += `- ${commitMessage} (${commit.sha.substring(0, 7)})\n`;
            });
          }
          
          releaseNotes += `\n## 下载地址\n\n`;
          releaseNotes += `- [XiBackpack-${version}.jar](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/download/${tagName}/XiBackpack-${version}.jar)\n`;
          
          // 设置输出
          core.setOutput('release_notes', releaseNotes);
          core.setOutput('version', version);

    - name: 获取 JAR 文件名
      if: steps.check_tag.outputs.exists == 'false'
      id: get_jar_name
      run: |
        JAR_FILE=$(ls target/*.jar | grep -v original | head -1)
        echo "jar_file=${JAR_FILE}" >> $GITHUB_OUTPUT
        echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

    - name: 创建 Release
      if: steps.check_tag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v2
      with:
        name: XiBackpack ${{ steps.get_version.outputs.version }}
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        body: ${{ steps.generate_release_notes.outputs.release_notes }}
        files: ${{ steps.get_jar_name.outputs.jar_file }}
        draft: false
        prerelease: false

  quality-check:
    name: Quality Check
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'adopt'
        cache: maven

    - name: Run Maven Verify
      run: mvn -B verify -DskipTests

    - name: Check Code Style
      run: mvn -B checkstyle:check

    - name: Check for Vulnerabilities
      run: mvn -B org.owasp:dependency-check-maven:check
      continue-on-error: true  # 漏洞检查结果不影响构建