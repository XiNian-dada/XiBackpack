name: CI/CD - Auto Release from POM Version

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œç”¨äºç”Ÿæˆå®Œæ•´çš„commitä¿¡æ¯

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'adopt'
        cache: maven

    - name: Build with Maven
      run: mvn -B compile

    - name: Run Tests
      run: mvn -B test

    - name: Package
      run: mvn -B package -DskipTests

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: XiBackpack-Build
        path: target/*.jar
        retention-days: 7

  auto-release:
    name: Auto Release from POM
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'adopt'
        cache: maven

    - name: è·å– POM ç‰ˆæœ¬å·
      id: get_version
      run: |
        VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT

    - name: æ£€æŸ¥ Tag æ˜¯å¦å·²å­˜åœ¨
      id: check_tag
      run: |
        if git rev-parse "${{ steps.get_version.outputs.tag_name }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: åˆ›å»º Tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a "${{ steps.get_version.outputs.tag_name }}" -m "Release ${{ steps.get_version.outputs.tag_name }}"
        git push origin "${{ steps.get_version.outputs.tag_name }}"

    - name: ç­‰å¾… Tag åŒæ­¥åˆ° GitHub API
      if: steps.check_tag.outputs.exists == 'false'
      run: sleep 5

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      if: steps.check_tag.outputs.exists == 'false'
      uses: actions/download-artifact@v4
      with:
        name: XiBackpack-Build
        path: target

    - name: ç”Ÿæˆ Release Notes
      id: generate_release_notes
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        # è·å–å½“å‰ç‰ˆæœ¬å’Œtag
        VERSION="${{ steps.get_version.outputs.version }}"
        TAG_NAME="${{ steps.get_version.outputs.tag_name }}"
        
        # è·å–æ‰€æœ‰æœ¬åœ°tagså¹¶æŒ‰ç‰ˆæœ¬å·æ’åºï¼ˆä»…åŒ…å«vå¼€å¤´çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼‰
        TAG_NAMES=$(git tag -l 'v*.*.*' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V -r)
        
        # å°†tagåˆ—è¡¨è½¬æ¢ä¸ºæ•°ç»„
        IFS=$'\n' read -r -a TAG_ARRAY <<< "$TAG_NAMES"
        
        # æ‰¾åˆ°å½“å‰tagçš„ä½ç½®
        CURRENT_INDEX=-1
        for i in "${!TAG_ARRAY[@]}"; do
          if [[ "${TAG_ARRAY[$i]}" == "$TAG_NAME" ]]; then
            CURRENT_INDEX=$i
            break
          fi
        done
        
        # æŸ¥æ‰¾å‰ä¸€ä¸ªç‰ˆæœ¬çš„tag
        PREVIOUS_TAG=""
        if [[ $CURRENT_INDEX -ne -1 && $CURRENT_INDEX -lt ${#TAG_ARRAY[@]}-1 ]]; then
          PREVIOUS_TAG="${TAG_ARRAY[$CURRENT_INDEX+1]}"
        fi
        
        # è·å–ä¸¤ä¸ªtagä¹‹é—´çš„commitsï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰
        COMMITS=""
        if [[ -n "$PREVIOUS_TAG" ]]; then
          COMMITS=$(git log "$PREVIOUS_TAG..$TAG_NAME" --pretty=format:"%h|%s|%an|%ad" --date=short)
        else
          COMMITS=$(git log --pretty=format:"%h|%s|%an|%ad" --date=short)
        fi
        
        # ç»Ÿè®¡æäº¤æ•°é‡
        COMMIT_COUNT=0
        if [[ -n "$COMMITS" ]]; then
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
        fi
        
        # ç”ŸæˆRelease Notes
        RELEASE_NOTES="## ğŸš€ XiBackpack $VERSION\n\n"
        RELEASE_NOTES+="**å‘å¸ƒæ—¶é—´**: $(date '+%Yå¹´%mæœˆ%dæ—¥')\n\n"
        
        if [[ -n "$PREVIOUS_TAG" ]]; then
          RELEASE_NOTES+="**å˜æ›´èŒƒå›´**: $PREVIOUS_TAG â†’ $TAG_NAME\n\n"
        fi
        
        RELEASE_NOTES+="### ğŸ“Š å˜æ›´ç»Ÿè®¡\n\n"
        RELEASE_NOTES+="- **æäº¤æ•°é‡**: $COMMIT_COUNT æ¬¡\n"
        RELEASE_NOTES+="- **æäº¤è€…**: $(echo "$COMMITS" | cut -d'|' -f3 | sort -u | wc -l | tr -d ' ') äºº\n\n"
        
        RELEASE_NOTES+="### ğŸ“ å˜æ›´å†…å®¹\n\n"
        
        if [[ -z "$COMMITS" ]]; then
          RELEASE_NOTES+"> â„¹ï¸ è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥æ²¡æœ‰å˜æ›´\n\n"
        else
          # æŒ‰æäº¤ç±»å‹åˆ†ç±»
          FEATURE_COMMITS=$(echo "$COMMITS" | grep -iE "^(feat|feature|add|æ–°å¢|æ·»åŠ )" || true)
          FIX_COMMITS=$(echo "$COMMITS" | grep -iE "^(fix|bug|ä¿®å¤|ä¿®æ­£)" || true)
          DOCS_COMMITS=$(echo "$COMMITS" | grep -iE "^(docs|doc|æ–‡æ¡£|readme)" || true)
          REFACTOR_COMMITS=$(echo "$COMMITS" | grep -iE "^(refactor|refact|é‡æ„|ä¼˜åŒ–)" || true)
          OTHER_COMMITS=$(echo "$COMMITS" | grep -vE "^(feat|feature|add|fix|bug|docs|doc|refactor|refact|æ–°å¢|æ·»åŠ |ä¿®å¤|ä¿®æ­£|æ–‡æ¡£|readme|é‡æ„|ä¼˜åŒ–)" || true)
          
          # åŠŸèƒ½æ–°å¢
          if [[ -n "$FEATURE_COMMITS" ]]; then
            RELEASE_NOTES+="#### âœ¨ æ–°åŠŸèƒ½\n\n"
            while IFS='|' read -r hash message author date; do
              RELEASE_NOTES+="- $message\n"
            done <<< "$FEATURE_COMMITS"
            RELEASE_NOTES+="\n"
          fi
          
          # é—®é¢˜ä¿®å¤
          if [[ -n "$FIX_COMMITS" ]]; then
            RELEASE_NOTES+="#### ğŸ› é—®é¢˜ä¿®å¤\n\n"
            while IFS='|' read -r hash message author date; do
              RELEASE_NOTES+="- $message\n"
            done <<< "$FIX_COMMITS"
            RELEASE_NOTES+="\n"
          fi
          
          # æ–‡æ¡£æ›´æ–°
          if [[ -n "$DOCS_COMMITS" ]]; then
            RELEASE_NOTES+="#### ğŸ“š æ–‡æ¡£æ›´æ–°\n\n"
            while IFS='|' read -r hash message author date; do
              RELEASE_NOTES+="- $message\n"
            done <<< "$DOCS_COMMITS"
            RELEASE_NOTES+="\n"
          fi
          
          # ä»£ç ä¼˜åŒ–
          if [[ -n "$REFACTOR_COMMITS" ]]; then
            RELEASE_NOTES+="#### âš¡ ä»£ç ä¼˜åŒ–\n\n"
            while IFS='|' read -r hash message author date; do
              RELEASE_NOTES+="- $message\n"
            done <<< "$REFACTOR_COMMITS"
            RELEASE_NOTES+="\n"
          fi
          
          # å…¶ä»–å˜æ›´
          if [[ -n "$OTHER_COMMITS" ]]; then
            RELEASE_NOTES+="#### ğŸ”§ å…¶ä»–å˜æ›´\n\n"
            while IFS='|' read -r hash message author date; do
              RELEASE_NOTES+="- $message\n"
            done <<< "$OTHER_COMMITS"
            RELEASE_NOTES+="\n"
          fi
        fi
        
        RELEASE_NOTES+="---\n\n"
        RELEASE_NOTES+="### ğŸ“¥ ä¸‹è½½åœ°å€\n\n"
        RELEASE_NOTES+="| æ–‡ä»¶å | ä¸‹è½½é“¾æ¥ |\n"
        RELEASE_NOTES+="|--------|----------|\n"
        RELEASE_NOTES+="| XiBackpack-${VERSION}.jar | [ä¸‹è½½](https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/XiBackpack-${VERSION}.jar) |\n\n"
        
        RELEASE_NOTES+="### ğŸ”— ç›¸å…³é“¾æ¥\n\n"
        RELEASE_NOTES+="- [å®Œæ•´æäº¤å†å²](https://github.com/${{ github.repository }}/commits/${TAG_NAME})\n"
        if [[ -n "$PREVIOUS_TAG" ]]; then
          RELEASE_NOTES+="- [ä¸ä¸Šä¸ªç‰ˆæœ¬çš„å·®å¼‚](https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${TAG_NAME})\n"
        fi
        RELEASE_NOTES+="- [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)\n\n"
        
        RELEASE_NOTES+="---\n\n"
        RELEASE_NOTES+="<details>\n"
        RELEASE_NOTES+="<summary>ğŸ“‹ è¯¦ç»†æäº¤åˆ—è¡¨</summary>\n\n"
        if [[ -n "$COMMITS" ]]; then
          while IFS='|' read -r hash message author date; do
            RELEASE_NOTES+="- **$hash** - $message\n"
            RELEASE_NOTES+="  - ä½œè€…: $author\n"
            RELEASE_NOTES+="  - æ—¥æœŸ: $date\n\n"
          done <<< "$COMMITS"
        fi
        RELEASE_NOTES+="</details>\n"
        
        # è®¾ç½®è¾“å‡º
        echo "release_notes<<EOF" >> "$GITHUB_OUTPUT"
        echo "$RELEASE_NOTES" >> "$GITHUB_OUTPUT"
        echo "EOF" >> "$GITHUB_OUTPUT"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"

    - name: è·å– JAR æ–‡ä»¶å
      if: steps.check_tag.outputs.exists == 'false'
      id: get_jar_name
      run: |
        JAR_FILE=$(ls target/*.jar | grep -v original | head -1)
        echo "jar_file=${JAR_FILE}" >> $GITHUB_OUTPUT
        echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

    - name: åˆ›å»º Release
      if: steps.check_tag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v2
      with:
        name: XiBackpack ${{ steps.get_version.outputs.version }}
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        body: ${{ steps.generate_release_notes.outputs.release_notes }}
        files: ${{ steps.get_jar_name.outputs.jar_file }}
        draft: false
        prerelease: false

  quality-check:
    name: Quality Check
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'adopt'
        cache: maven

    - name: Run Maven Verify
      run: mvn -B verify -DskipTests

    - name: Check Code Style
      run: mvn -B checkstyle:check

    - name: Check for Vulnerabilities
      run: mvn -B org.owasp:dependency-check-maven:check
      continue-on-error: true  # æ¼æ´æ£€æŸ¥ç»“æœä¸å½±å“æ„å»º